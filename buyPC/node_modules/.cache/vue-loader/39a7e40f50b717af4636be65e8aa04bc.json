{"remainingRequest":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\src\\page\\settlementPage\\index.vue?vue&type=style&index=0&id=3075cfd2&lang=scss","dependencies":[{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\src\\page\\settlementPage\\index.vue","mtime":1760944158217},{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\css-loader\\dist\\cjs.js","mtime":1761044715569},{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1761044717168},{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\postcss-loader\\src\\index.js","mtime":1761044716266},{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\sass-loader\\dist\\cjs.js","mtime":1761044715084},{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1761044715083},{"path":"C:\\Users\\HP\\Desktop\\tk08\\tiktok08\\buyPC\\node_modules\\vue-loader\\lib\\index.js","mtime":1761044716737}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQouc2V0dGxlbWVudCB7DQogICYtY29udGVudCB7DQogICAgLnRpdGxlIHsNCiAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7DQogICAgICBmb250LXNpemU6IDI0cHg7DQogICAgICBjb2xvcjogdmFyKC0tY29sb3ItdGl0bGUpOw0KICAgICAgbWFyZ2luLWJvdHRvbTogMTJweDsNCiAgICB9DQoNCiAgICAuc3VidGl0bGUgew0KICAgICAgZm9udC13ZWlnaHQ6IDYwMDsNCiAgICAgIGZvbnQtc2l6ZTogMjBweDsNCiAgICAgIGNvbG9yOiB2YXIoLS1jb2xvci10aXRsZSk7DQogICAgICBtYXJnaW4tYm90dG9tOiAxNXB4Ow0KICAgIH0NCiAgfQ0KDQogICYtcmVjZWl2ZXIgew0KICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWNvbG9yLWJvcmRlcik7DQogICAgcGFkZGluZzogMTZweCAyMHB4Ow0KICAgIGJvcmRlci1yYWRpdXM6IDRweDsNCiAgICBtYXJnaW4tYm90dG9tOiAxMnB4Ow0KICAgIGN1cnNvcjogcG9pbnRlcjsNCg0KICAgIC51c2VyaW5mbyB7DQogICAgICBmb250LXdlaWdodDogNTAwOw0KICAgICAgZm9udC1zaXplOiAxMnB4Ow0KICAgICAgY29sb3I6IHZhcigtLWNvbG9yLXRpdGxlKTsNCiAgICAgIG1hcmdpbi1ib3R0b206IDVweDsNCiAgICB9DQoNCiAgICAuYWRkcmVzcyB7DQogICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgICBmb250LXdlaWdodDogNTAwOw0KICAgICAgbWF4LXdpZHRoOiAxMDAwcHggIWltcG9ydGFudDsNCiAgICAgIG92ZXJmbG93OmhpZGRlbjsgLy/otoXlh7rnmoTmlofmnKzpmpDol48NCiAgICAgIHRleHQtb3ZlcmZsb3c6ZWxsaXBzaXM7IC8v5rqi5Ye655So55yB55Wl5Y+35pi+56S6DQogICAgICB3aGl0ZS1zcGFjZTpub3dyYXA7IC8v5rqi5Ye65LiN5o2i6KGMDQogICAgICBmb250LXNpemU6IDEycHg7DQogICAgICBjb2xvcjogdmFyKC0tY29sb3Itc3VidGl0bGUpOw0KICAgIH0NCg0KICAgIGRpdjpmaXJzdC1jaGlsZCB7DQogICAgICBmbGV4OiAxOw0KICAgIH0NCg0KICAgIGRpdjpsYXN0LWNoaWxkIHsNCiAgICAgIHdpZHRoOiA1MHB4Ow0KICAgICAgdGV4dC1hbGlnbjogcmlnaHQ7DQogICAgfQ0KICB9DQoNCiAgJi1wYXkgew0KICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWNvbG9yLWJvcmRlcik7DQogICAgcGFkZGluZzogMTFweCAyMHB4Ow0KICAgIG1hcmdpbjogNDBweCAwOw0KDQogICAgJi1sYWJlbCB7DQogICAgICBmb250LXdlaWdodDogNTAwOw0KICAgICAgZm9udC1zaXplOiAxMnB4Ow0KICAgICAgY29sb3I6IHZhcigtLWNvbG9yLXRpdGxlKTsNCg0KICAgICAgc3BhbiB7DQogICAgICAgIGNvbG9yOiB2YXIoLS1jb2xvci1tYWluKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgICAuZWwtYnV0dG9uIHsNCiAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7DQogICAgICBmb250LXNpemU6IDE0cHg7DQogICAgICBjb2xvcjogdmFyKC0tY29sb3Itd2hpdGUpOw0KDQogICAgICBzcGFuOmZpcnN0LWNoaWxkIHsNCiAgICAgICAgbWFyZ2luLXJpZ2h0OiAxMHB4Ow0KICAgICAgfQ0KICAgIH0NCiAgfQ0KfQ0K"},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AA8TA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/page/settlementPage","sourcesContent":["<template>\r\n  <div class=\"settlement\">\r\n    <EsHeaderView />\r\n    <div class=\"settlement-content app-container\">\r\n      <h1 class=\"title\">{{ $t(\"message.home.checkout\") }}</h1>\r\n      <h2 class=\"subtitle\">{{ $t(\"message.home.shippingAddress\") }}</h2>\r\n      <div class=\"settlement-receiver flex-between\" @click=\"selectAddressEvent\">\r\n        <div>\r\n          <div class=\"userinfo\">\r\n            <span>\r\n              {{ paySelectAddress.contacts }} +{{ paySelectAddress.phone }}\r\n            </span>\r\n          </div>\r\n          <p class=\"address\">\r\n            {{ paySelectAddress.country }} {{ paySelectAddress.province }}\r\n            {{ paySelectAddress.city }}\r\n            {{ paySelectAddress.address }}\r\n          </p>\r\n        </div>\r\n        <div><i class=\"el-icon-arrow-right\"></i></div>\r\n      </div>\r\n      <EsOrderList />\r\n      <EsOrderSum :checkGoods=\"chcekData\" />\r\n      <EsPayMethod />\r\n      <div class=\"settlement-pay flex-between\">\r\n        <div class=\"settlement-pay-label\">\r\n          {{ $t(\"message.home.Opt\") }}\r\n          <span>{{ checkNum }}</span>\r\n          {{ $t(\"message.home.piece\") }}\r\n        </div>\r\n        <el-button type=\"primary\" @click=\"pay\">\r\n          <span>{{ $t(\"message.home.subOrder\") }}</span>\r\n          <span>${{ checkTotalAmount }}</span>\r\n        </el-button>\r\n      </div>\r\n      <EsIconTips />\r\n    </div>\r\n    <EsFooterView />\r\n    <EsPayModal\r\n      v-model=\"payModalShow\"\r\n      :payCallback=\"payCallback\"\r\n      @changeShowModel=\"changeShowModel\"\r\n    />\r\n    <AddressDialog\r\n      v-model=\"addAddressModalShow\"\r\n      @showAddAddressView=\"showAddAddressView\"\r\n    />\r\n    <!-- <AddAddressDialog :addAddressView=\"addAddressView\" @showAddAddressView=\"showAddAddressView\" /> -->\r\n    <EsAddAddress v-model=\"addAddressView\" />\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapGetters, mapActions, mapMutations } from \"vuex\";\r\nimport EsIconTips from \"@/components/iconTips\";\r\nimport EsOrderSum from \"./orderSum.vue\";\r\nimport EsOrderList from \"./orderList.vue\";\r\nimport EsPayMethod from \"./payMethod.vue\";\r\nimport EsPayModal from \"./payModal.vue\";\r\nimport AddressDialog from \"./address\";\r\n// import AddAddressDialog from './addAddress'\r\nimport { setShopCartLocal, getShopCartLocal } from \"@/util/shop\";\r\nimport { numberFormat } from \"@/util\";\r\nimport EsAddAddress from \"@/components/addAddress\";\r\n\r\n// import { SetSafewordApi } from \"@/api\";\r\n\r\nexport default {\r\n  name: \"EsSettlement\",\r\n  components: {\r\n    EsIconTips,\r\n    EsOrderSum,\r\n    EsOrderList,\r\n    EsPayMethod,\r\n    EsPayModal,\r\n    AddressDialog,\r\n    // AddAddressDialog,\r\n    EsAddAddress,\r\n  },\r\n  data() {\r\n    return {\r\n      payModalShow: false,\r\n      addAddressModalShow: false,\r\n      selectAddress: {},\r\n      currentSubmitOrderIds: [],\r\n      addAddressView: false,\r\n      chcekData: [],\r\n      checkNum: 0,\r\n      lastSubmit: {\r\n        orderIds: \"\",\r\n        addressId: \"\",\r\n        orderInfo: {},\r\n      },\r\n    };\r\n  },\r\n  computed: {\r\n    ...mapGetters({\r\n      addressList: \"user/addressList\",\r\n      defaultAddress: \"user/defaultAddress\",\r\n      paySelectAddress: \"user/paySelectAddress\",\r\n      checkProductPay: \"shopCart/checkProductPay\",\r\n      userBalance: \"user/userBalance\",\r\n      userInfo: \"userInfo\",\r\n    }),\r\n    checkCount() {\r\n      return this.checkProductPay.reduce(\r\n        (a, b) => a + b.list.reduce((i, l) => i + l.checkTotal, 0),\r\n        0\r\n      );\r\n    },\r\n    checkTotalAmount() {\r\n      return numberFormat(\r\n        this.getChcekData().reduce(\r\n          (a, b) =>\r\n            a +\r\n            ((b.price || b.discountPrice || b.sellingPrice) +\r\n              (b.goodsTax ?? 0) +\r\n              (b.freightAmount ?? 0)) *\r\n              b.checkTotal,\r\n          0\r\n        )\r\n      );\r\n    },\r\n    isDisabledPayBtn() {\r\n      return (\r\n        this.userBalance <= 0 ||\r\n        this.checkCount <= 0 ||\r\n        this.userBalance < this.checkTotalAmount\r\n      );\r\n    },\r\n    // checkProduct() {\r\n    //     console.log('-----11111111----')\r\n    //     return this.getChcekData();\r\n    // }\r\n  },\r\n  async mounted() {\r\n    await this.requestAddressList();\r\n    this.$nextTick(() => {\r\n      this.updatePaySelectAddress(this.defaultAddress);\r\n    });\r\n  },\r\n  methods: {\r\n    ...mapMutations({\r\n      updatePaySelectAddress: \"user/updatePaySelectAddress\",\r\n      updateCheckProductPay: \"shopCart/updateCheckProductPay\",\r\n      updateShopCart: \"shopCart/updateShopCart\",\r\n    }),\r\n    ...mapActions({\r\n      requestAddressList: \"user/requestAddressList\",\r\n      requestOrderPay: \"order/requestOrderPay\",\r\n      setSafewordFunc: \"order/setSafewordFunc\",\r\n      requestOrderSubmit: \"order/requestOrderSubmit\",\r\n    }),\r\n    changeShowModel(e) {\r\n      this.showModel = e;\r\n    },\r\n    showAddAddressView(bool) {\r\n      this.addAddressView = !this.addAddressView;\r\n      if (!this.addAddressView) {\r\n        this.requestAddressList();\r\n      }\r\n    },\r\n    getChcekData() {\r\n      let data = [];\r\n      this.checkProductPay.forEach((item) => {\r\n        data = [\r\n          ...data,\r\n          ...item.list.filter(\r\n            (listItem) => item.checkList.indexOf(listItem.Identifier) > -1\r\n          ),\r\n        ];\r\n      });\r\n      this.chcekData = data;\r\n      // console.log(\"this.checkData ->\", this.data);\r\n      this.checkNum = data.length;\r\n      return data;\r\n    },\r\n    async pay() {\r\n      if (!this.paySelectAddress?.id) {\r\n        return this.$message.error(\r\n          this.$t(\"message.home.ShippingAddressNotSet\" /* 未设置收货地址 */)\r\n        );\r\n      }\r\n\r\n      const checkData = this.getChcekData();\r\n      // const ids = checkData.map((item) => item.id)\r\n      // console.log(this.paySelectAddress, this.defaultAddress)\r\n\r\n      checkData.map((item) => [item.id, item.checkTotal]).join(\",\");\r\n\r\n      const orderInfo = checkData\r\n        .map((item) => [item.id, item.skuid || -1, item.checkTotal])\r\n        .join(\",\");\r\n      if (!orderInfo) {\r\n        return this.$message.error(\r\n          this.$t(\"message.home.NoProductSelected\" /* 请选择商品 */)\r\n        );\r\n      }\r\n      const addressId = this.paySelectAddress.id;\r\n      if (\r\n        !(\r\n          this.lastSubmit.orderIds &&\r\n          this.lastSubmit.addressId == addressId &&\r\n          this.lastSubmit.orderInfo == orderInfo\r\n        )\r\n      ) {\r\n        const result = await this.requestOrderSubmit({\r\n          orderInfo: orderInfo,\r\n          addressId: addressId,\r\n        });\r\n        this.currentSubmitOrderIds = result.orderList.map(\r\n          (item) => item.orderId\r\n        );\r\n        localStorage.setItem(\r\n          \"currentSubmitOrderIds\",\r\n          this.currentSubmitOrderIds\r\n        );\r\n        this.lastSubmit = {\r\n          orderInfo,\r\n          orderIds: this.currentSubmitOrderIds,\r\n          addressId,\r\n        };\r\n        // console.log(JSON.stringify(this.lastSubmit))\r\n      } else {\r\n        console.log(\"-----use last submit----\");\r\n      }\r\n      if (!this.userInfo.safeword) {\r\n        // 设置支付密码\r\n        this.payModalShow = true;\r\n        this.showModel = 1;\r\n        return;\r\n      }\r\n      if (!this.checkoutAmount()) {\r\n        console.log(11111222);\r\n        return;\r\n      }\r\n      this.payModalShow = true;\r\n    },\r\n    cleartCheckData(ids) {\r\n      this.checkProductPay.forEach((item) => {\r\n        item.list = item.list.filter((listItem) => !ids.includes(listItem.id));\r\n      });\r\n      this.updateCheckProductPay(\r\n        this.checkProductPay.filter((item) => !!item.list.length)\r\n      );\r\n    },\r\n    selectAddressEvent() {\r\n      this.addAddressModalShow = true;\r\n    },\r\n    async payCallback(password, successCallBack, failCallBack) {\r\n      if (!this.checkoutAmount()) {\r\n        return;\r\n      }\r\n      if (!this.currentSubmitOrderIds.length) {\r\n        this.currentSubmitOrderIds = localStorage.getItem(\r\n          \"currentSubmitOrderIds\"\r\n        );\r\n      }\r\n      console.log(\"this.currentSubmitOrderIds ->\", this.currentSubmitOrderIds);\r\n      await this.requestOrderPay({\r\n        orderId: this.currentSubmitOrderIds.join(\",\"),\r\n        safeword: password,\r\n      })\r\n        .then(() => {\r\n          // let shopCartData = getShopCartLocal();\r\n          const shopCartData = getShopCartLocal().then(result =>{\r\n            console.log('getShopCartLocal ->', result);\r\n            return result;\r\n          });\r\n          const checkData = this.getChcekData();\r\n          if (shopCartData && shopCartData.length) {\r\n            const checkIds = checkData.map((item) => item.attrTime);\r\n            shopCartData = shopCartData.filter(\r\n              (item) => !checkIds.includes(item.attrTime)\r\n            );\r\n            // console.log('2232323 ->', 2232323);\r\n            // 支付成功后，清除购物车中的订单\r\n            // console.log('shopCartData ->', shopCartData);\r\n            this.getShopCartLocal(shopCartData);\r\n          }\r\n      const list = []\r\n          this.updateShopCart(list)\r\n          successCallBack && successCallBack();\r\n          this.$router.replace(\"/paySuccess\");\r\n        })\r\n        .catch(() => {\r\n          failCallBack && failCallBack();\r\n        })\r\n        .finally(() => {\r\n          localStorage.removeItem(\"currentSubmitOrderIds\");\r\n          this.payModalShow = false;\r\n        });\r\n    },\r\n    checkoutAmount() {\r\n      if (this.isDisabledPayBtn) {\r\n        if (this.checkTotalAmount.at(0) == \"0\") {\r\n          this.$message({\r\n            message: this.$t(\r\n              \"message.home.NoProductSelected\" /**还未选择商品 */\r\n            ),\r\n            type: \"error\",\r\n          });\r\n        } else {\r\n          this.$message({\r\n            message: this.$t(\"message.home.balanceNot\" /**余额不足，请充值 */),\r\n            type: \"error\",\r\n          });\r\n        }\r\n        this.payModalShow = false;\r\n        return false;\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n.settlement {\r\n  &-content {\r\n    .title {\r\n      font-weight: 600;\r\n      font-size: 24px;\r\n      color: var(--color-title);\r\n      margin-bottom: 12px;\r\n    }\r\n\r\n    .subtitle {\r\n      font-weight: 600;\r\n      font-size: 20px;\r\n      color: var(--color-title);\r\n      margin-bottom: 15px;\r\n    }\r\n  }\r\n\r\n  &-receiver {\r\n    border: 1px solid var(--color-border);\r\n    padding: 16px 20px;\r\n    border-radius: 4px;\r\n    margin-bottom: 12px;\r\n    cursor: pointer;\r\n\r\n    .userinfo {\r\n      font-weight: 500;\r\n      font-size: 12px;\r\n      color: var(--color-title);\r\n      margin-bottom: 5px;\r\n    }\r\n\r\n    .address {\r\n      display: inline-block;\r\n      font-weight: 500;\r\n      max-width: 1000px !important;\r\n      overflow:hidden; //超出的文本隐藏\r\n      text-overflow:ellipsis; //溢出用省略号显示\r\n      white-space:nowrap; //溢出不换行\r\n      font-size: 12px;\r\n      color: var(--color-subtitle);\r\n    }\r\n\r\n    div:first-child {\r\n      flex: 1;\r\n    }\r\n\r\n    div:last-child {\r\n      width: 50px;\r\n      text-align: right;\r\n    }\r\n  }\r\n\r\n  &-pay {\r\n    border: 1px solid var(--color-border);\r\n    padding: 11px 20px;\r\n    margin: 40px 0;\r\n\r\n    &-label {\r\n      font-weight: 500;\r\n      font-size: 12px;\r\n      color: var(--color-title);\r\n\r\n      span {\r\n        color: var(--color-main);\r\n      }\r\n    }\r\n\r\n    .el-button {\r\n      font-weight: 700;\r\n      font-size: 14px;\r\n      color: var(--color-white);\r\n\r\n      span:first-child {\r\n        margin-right: 10px;\r\n      }\r\n    }\r\n  }\r\n}\r\n</style>\r\n"]}]}